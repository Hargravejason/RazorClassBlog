@page
@using RazorClassBlog.EnumsandConstants
@model RazorClassBlog.Areas.BlogAdmin.IndexModel

@{
  ViewData["Title"] = "Blog Admin";
}

<section class="mt-3 mb-4">
  <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2">
    <div>
      <h1 class="mb-1">Blog Posts</h1>
      <p class="text-muted mb-0">
        Manage your blog content, drafts, and published posts.
      </p>
    </div>
    <div>
      <a asp-page="Edit" class="btn btn-primary">
        <i class="bi bi-plus-lg"></i> Create New Post
      </a>
    </div>
  </div>
</section>

<form method="get" class="mb-3">
  <div class="row g-2 align-items-end">
    <div class="col-md-4">
      <label class="form-label">Search</label>
      <input type="text"
             name="Search"
             value="@Model.Search"
             class="form-control"
             placeholder="Title or content..." />
    </div>
    <div class="col-md-3">
      <label class="form-label">Status</label>
      <select name="Status" class="form-select">
        <option value="">All statuses</option>
        @foreach (var status in Enum.GetValues<BlogPostStatus>())
        {
          <option value="@status">
            @status
          </option>
        }
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Tag</label>
      <input type="text"
             name="Tag"
             value="@Model.Tag"
             class="form-control"
             placeholder="e.g. Updates" />
    </div>
    <div class="col-md-2 d-grid">
      <button type="submit" class="btn btn-outline-secondary">Filter</button>
    </div>
  </div>
</form>

@if (!Model.Posts.Items.Any())
{
  <div class="alert alert-info">
    No posts found. Try changing your filters or create a new post.
  </div>
}
else
{
  <div class="table-responsive">
    <table class="table table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>Title</th>
          <th>Status</th>
          <th>Tags</th>
          <th class="text-end">Actions</th>
        </tr>
      </thead>
      <tbody>
        @foreach (var post in Model.Posts.Items)
        {
          var published = post.PublishedUtc?.ToLocalTime().ToString("yyyy-MM-dd HH:mm") ?? "-";

          <tr>
            <td>
              <div class="fw-semibold">@post.Title</div>
              <div class="small text-muted">
                Slug: @post.Slug
              </div>
            </td>
            <td>
              @{
                var nowUtc = DateTimeOffset.UtcNow;
                var isScheduled = post.Status == BlogPostStatus.Published
                && post.PublishedUtc.HasValue
                && post.PublishedUtc.Value > nowUtc;
              }

              @if (isScheduled)
              {
                <span class="badge bg-info text-dark me-1">Scheduled</span>
              }
              else
              {
                @switch (post.Status)
                {
                  case BlogPostStatus.Draft:
                    <span class="badge bg-secondary">Draft</span>
                    break;
                  case BlogPostStatus.Published:
                    <span class="badge bg-success">Published</span>
                    break;
                  case BlogPostStatus.Archived:
                    <span class="badge bg-warning text-dark">Archived</span>
                    break;
                }
              }
            </td>
            <td>
              @if (post.Tags?.Any() == true)
              {
                @foreach (var tag in post.Tags)
                {
                  <span class="badge text-bg-light me-1">@tag</span>
                }
              }
            </td>
            <td class="text-end">
              <div class="btn-group">
                <a asp-page="Edit"
                   asp-route-id="@post.Id"
                   class="btn btn-sm btn-outline-primary">
                  Edit
                </a>

                <button type="button"
                        class="btn btn-sm btn-outline-danger"
                        data-bs-toggle="modal"
                        data-bs-target="#deletePostModal"
                        data-post-id="@post.Id"
                        data-post-title="@post.Title">
                  Delete
                </button>
              </div>
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>

  <div class="modal fade" id="deletePostModal" tabindex="-1" aria-labelledby="deletePostModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="deletePostModalLabel">Delete blog post</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form method="post" asp-page-handler="Delete">
          <div class="modal-body">
            <input type="hidden" name="id" id="deletePostId" />

            <p>
              Are you sure you want to delete this post?
            </p>
            <p class="mb-0">
              <strong id="deletePostTitle"></strong>
            </p>
            <p class="text-muted small mb-0">
              This action cannot be undone.
            </p>
          </div>
          <div class="modal-footer">
            <button type="button"
                    class="btn btn-outline-secondary"
                    data-bs-dismiss="modal">
              Cancel
            </button>
            <button type="submit"
                    class="btn btn-danger">
              Yes, delete it
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <nav class="mt-3 d-flex justify-content-between align-items-center" aria-label="Admin blog pagination">
    <div>
      Showing page @Model.Posts.Page of @Model.Posts.TotalPages
    </div>
    <div class="btn-group">
      @if (Model.Posts.HasPreviousPage)
      {
        <a asp-page="Index"
           asp-route-PageNumber="@(Model.Posts.Page - 1)"
           asp-route-Search="@Model.Search"
           asp-route-Status="@Model.Status"
           asp-route-Tag="@Model.Tag"
           class="btn btn-outline-secondary btn-sm">
          &laquo; Previous
        </a>
      }

      @if (Model.Posts.HasNextPage)
      {
        <a asp-page="Index"
           asp-route-PageNumber="@(Model.Posts.Page + 1)"
           asp-route-Search="@Model.Search"
           asp-route-Status="@Model.Status"
           asp-route-Tag="@Model.Tag"
           class="btn btn-outline-secondary btn-sm">
          Next &raquo;
        </a>
      }
    </div>
  </nav>
}

@section Scripts {
  <script>
    document.addEventListener("DOMContentLoaded", function () {
        var deleteModal = document.getElementById('deletePostModal');
        if (!deleteModal) return;

        deleteModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            if (!button) return;

            var postId = button.getAttribute('data-post-id');
            var postTitle = button.getAttribute('data-post-title');

            var idInput = document.getElementById('deletePostId');
            var titleSpan = document.getElementById('deletePostTitle');

            if (idInput) {
                idInput.value = postId || '';
            }
            if (titleSpan) {
                titleSpan.textContent = postTitle || '';
            }
        });
    });
  </script>
}
